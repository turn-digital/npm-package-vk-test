{"version":3,"file":"focus-plugin.js","names":["on","config","fp","focusCalendar","calendarContainer","selectedDateElem","todayDateElem","focus","handleBlur","target","relatedTarget","isOpen","contains","inputFrom","inputTo","Promise","resolve","then","rootNode","getRootNode","nodeType","Node","DOCUMENT_NODE","DOCUMENT_FRAGMENT_NODE","_lastFocusInput","close","handleInputKeydown","event","key","preventDefault","open","setTimeout","handleInputFocus","release","_hCDSCEDatePickerFocusPluginBlur","_hCDSCEDatePickerFocusPluginFocusTo","_hCDSCEDatePickerFocusPluginFocusFrom","_hCDSCEDatePickerFocusPluginKeydownTo","_hCDSCEDatePickerFocusPluginKeydownFrom","init","register","loadedPlugins","push","onReady","onDestroy"],"sources":["components/date-picker/focus-plugin.ts"],"sourcesContent":["/**\n * @license\n *\n * Copyright IBM Corp. 2019, 2023\n *\n * This source code is licensed under the Apache-2.0 license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\nimport { Instance as FlatpickrInstance } from 'flatpickr/dist/types/instance';\nimport { Plugin } from 'flatpickr/dist/types/options';\nimport on from '../../globals/mixins/on';\nimport Handle from '../../globals/internal/handle';\nimport CDSDatePickerInput from './date-picker-input';\n\n/**\n * The configuration for the Flatpickr plugin to set CSS classes specific to this design system.\n */\nexport interface DatePickerFocusPluginConfig {\n  /**\n   * The input box to enter starting date.\n   */\n  inputFrom: CDSDatePickerInput;\n\n  /**\n   * The input box to enter end date.\n   */\n  inputTo?: CDSDatePickerInput;\n}\n\n/**\n * `FlatpickrInstance` with additional properties used for `carbonFlatpickrFocusPlugin`.\n */\nexport interface ExtendedFlatpickrInstanceFocusPlugin\n  extends FlatpickrInstance {\n  /**\n   * The handle for `blur` event handler in calendar dropdown.\n   */\n  _hCDSCEDatePickerFocusPluginBlur?: Handle | null;\n\n  /**\n   * The handle for `keydown` event handler in the `<input>` for the starting date.\n   */\n  _hCDSCEDatePickerFocusPluginKeydownFrom?: Handle | null;\n\n  /**\n   * The handle for `keydown` event handler in the `<input>` for the end date.\n   */\n  _hCDSCEDatePickerFocusPluginKeydownTo?: Handle | null;\n\n  /**\n   * The handle for `focus` event handler in the `<input>` for the starting date.\n   */\n  _hCDSCEDatePickerFocusPluginFocusFrom?: Handle | null;\n\n  /**\n   * The handle for `focus` event handler in the `<input>` for the end date.\n   */\n  _hCDSCEDatePickerFocusPluginFocusTo?: Handle | null;\n\n  /**\n   * Lastly focused `<input>` for starting/end date.\n   */\n  _lastFocusInput?: HTMLInputElement;\n}\n\n/**\n * @param config Plugin configuration.\n * @returns A Flatpickr plugin to manage focus to align with the UX pattern in our design system.\n */\nexport default (config: DatePickerFocusPluginConfig): Plugin =>\n  (fp: ExtendedFlatpickrInstanceFocusPlugin) => {\n    /**\n     * Focuses on calendar dropdown.\n     */\n    const focusCalendar = () => {\n      const { calendarContainer, selectedDateElem, todayDateElem } = fp;\n      (selectedDateElem || todayDateElem || calendarContainer).focus();\n    };\n\n    /**\n     * Handles `blur` event to move the focus back to the `<input>`.\n     */\n    const handleBlur = ({ target, relatedTarget }: FocusEvent) => {\n      // Obtains `beingUpdated` up-front because it'll be flushed out shortly\n      const { calendarContainer, isOpen } = fp;\n      if (\n        isOpen &&\n        calendarContainer.contains(target as Node) &&\n        !calendarContainer.contains(relatedTarget as Node) &&\n        relatedTarget !== config.inputFrom &&\n        relatedTarget !== config.inputTo\n      ) {\n        Promise.resolve().then(() => {\n          const rootNode = (target as Node).getRootNode();\n          // This `blur` event handler can be called from Flatpickr's code,\n          // cleaning up the calendar dropdowns DOM. Changing focus in such\n          // condition causes removing an orphaned DOM node, because Flatpickr\n          // redraws the calendar dropdown when the `<input>` gets focus.\n          if (\n            rootNode.nodeType === Node.DOCUMENT_NODE ||\n            rootNode.nodeType === Node.DOCUMENT_FRAGMENT_NODE\n          ) {\n            if (fp._lastFocusInput === config.inputTo) {\n              config.inputTo!.focus();\n            } else {\n              config.inputFrom.focus();\n            }\n            // Closing after moving focus. Reversing the order will cause re-opening calendar dropdown upon focusing\n            fp.close();\n          }\n        });\n      }\n    };\n\n    /**\n     * Handles `keydown` event to move focus on calendar dropdown.\n     */\n    const handleInputKeydown = (event: KeyboardEvent) => {\n      const { key } = event;\n      if (key === 'ArrowDown' || key === 'Down' || key === 'Enter') {\n        event.preventDefault();\n        fp.open();\n        if (key !== 'Enter') {\n          focusCalendar();\n        } else {\n          // Hitting Enter key blurs the `<input>`, causing any element to lose focus\n          setTimeout(focusCalendar, 0);\n        }\n      }\n    };\n\n    /**\n     * Handles `focus` event on `<input>` for starting/end date to track the lastly focused one.\n     */\n    const handleInputFocus = ({ target }: FocusEvent) => {\n      fp._lastFocusInput = target as HTMLInputElement;\n    };\n\n    /**\n     * Releases event listeners used in this Flatpickr plugin.\n     */\n    const release = () => {\n      if (fp._hCDSCEDatePickerFocusPluginBlur) {\n        fp._hCDSCEDatePickerFocusPluginBlur =\n          fp._hCDSCEDatePickerFocusPluginBlur.release();\n      }\n      if (fp._hCDSCEDatePickerFocusPluginFocusTo) {\n        fp._hCDSCEDatePickerFocusPluginFocusTo =\n          fp._hCDSCEDatePickerFocusPluginFocusTo.release();\n      }\n      if (fp._hCDSCEDatePickerFocusPluginFocusFrom) {\n        fp._hCDSCEDatePickerFocusPluginFocusFrom =\n          fp._hCDSCEDatePickerFocusPluginFocusFrom.release();\n      }\n      if (fp._hCDSCEDatePickerFocusPluginKeydownTo) {\n        fp._hCDSCEDatePickerFocusPluginKeydownTo =\n          fp._hCDSCEDatePickerFocusPluginKeydownTo.release();\n      }\n      if (fp._hCDSCEDatePickerFocusPluginKeydownFrom) {\n        fp._hCDSCEDatePickerFocusPluginKeydownFrom =\n          fp._hCDSCEDatePickerFocusPluginKeydownFrom.release();\n      }\n    };\n\n    /**\n     * Sets up event listeners used for this Flatpickr plugin.\n     */\n    const init = () => {\n      release();\n      const { inputFrom, inputTo } = config;\n      fp._hCDSCEDatePickerFocusPluginBlur = on(\n        fp.calendarContainer,\n        'blur',\n        handleBlur,\n        true\n      );\n      fp._hCDSCEDatePickerFocusPluginKeydownFrom = on(\n        inputFrom,\n        'keydown',\n        handleInputKeydown\n      );\n      if (inputTo) {\n        fp._hCDSCEDatePickerFocusPluginKeydownTo = on(\n          inputTo,\n          'keydown',\n          handleInputKeydown\n        );\n      }\n      fp._hCDSCEDatePickerFocusPluginFocusFrom = on(\n        inputFrom,\n        'focus',\n        handleInputFocus\n      );\n      if (inputTo) {\n        fp._hCDSCEDatePickerFocusPluginFocusTo = on(\n          inputTo,\n          'focus',\n          handleInputFocus\n        );\n      }\n    };\n\n    /**\n     * Registers this Flatpickr plugin.\n     *\n     */\n    const register = () => {\n      fp.loadedPlugins.push('carbonFlatpickrFocusPlugin');\n    };\n\n    return {\n      onReady: [register, init],\n      onDestroy: release,\n    };\n  };\n"],"mappings":"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"}